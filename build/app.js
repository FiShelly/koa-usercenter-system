!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=19)}([function(e,t){e.exports=require("sequelize")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("md5")},function(e,t){e.exports=require("koa-log4")},function(e,t,r){var n,a,o=r(18),s=r(16),i=0,c=0;e.exports=function(e,t,r){var u=t&&r||0,l=t||[],d=(e=e||{}).node||n,p=void 0!==e.clockseq?e.clockseq:a;if(null==d||null==p){var y=o();null==d&&(d=n=[1|y[0],y[1],y[2],y[3],y[4],y[5]]),null==p&&(p=a=16383&(y[6]<<8|y[7]))}var f=void 0!==e.msecs?e.msecs:(new Date).getTime(),m=void 0!==e.nsecs?e.nsecs:c+1,g=f-i+(m-c)/1e4;if(g<0&&void 0===e.clockseq&&(p=p+1&16383),(g<0||f>i)&&void 0===e.nsecs&&(m=0),m>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");i=f,c=m,a=p;var w=(1e4*(268435455&(f+=122192928e5))+m)%4294967296;l[u++]=w>>>24&255,l[u++]=w>>>16&255,l[u++]=w>>>8&255,l[u++]=255&w;var h=f/4294967296*1e4&268435455;l[u++]=h>>>8&255,l[u++]=255&h,l[u++]=h>>>24&15|16,l[u++]=h>>>16&255,l[u++]=p>>>8|128,l[u++]=255&p;for(var b=0;b<6;++b)l[u+b]=d[b];return t||s(l)}},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("koa-csrf")},function(e,t){e.exports=require("koa-send")},function(e,t){e.exports=require("koa-session")},function(e,t){e.exports=require("koa-body")},function(e,t){e.exports=require("koa")},function(e,t,r){"use strict";r.r(t);var n={port:4e3,ssl:{path:"",key:"",pem:"",port:443,passphrase:""},host:"http://localhost:3200/",useHttps:!1,log:{appenders:{out:{type:"console"},http:{type:"dateFile",filename:"./logs/http",pattern:"-yyyy-MM-dd.log",alwaysIncludePattern:!0},error:{type:"dateFile",filename:"./logs/error",pattern:"-yyyy-MM-dd.log",alwaysIncludePattern:!0},app:{type:"dateFile",filename:"./logs/app",pattern:"-yyyy-MM-dd.log",alwaysIncludePattern:!0},startup:{type:"dateFile",filename:"./logs/startup",pattern:"-yyyy-MM-dd.log",alwaysIncludePattern:!0},default:{type:"dateFile",filename:"./logs/default",pattern:"-yyyy-MM-dd.log",alwaysIncludePattern:!0},mysql:{type:"dateFile",filename:"./logs/mysql",pattern:"-yyyy-MM-dd.log",alwaysIncludePattern:!0}},categories:{default:{appenders:["out","default"],level:"info"},http:{appenders:["http"],level:"info"},startup:{appenders:["out","startup"],level:"info"},error:{appenders:["error"],level:"error"},app:{appenders:["app"],level:"info"},mysql:{appenders:["mysql"],level:"info"}}}},a=r(14),o=r.n(a),s=r(13),i=r(12),c=r.n(i),u=r(6),l=r.n(u);l.a.configure(n.log);const d=':remote-addr - - ":method :url HTTP/:http-version" :status :content-length ":referrer" ":user-agent" "time： :response-time"';var p={log4js:l.a,routeLoggerMiddleware:function(){return async function(e,t){const r=new Date;e.logger=l.a,await t();const n=new Date-r;l.a.getLogger("app").info(`${e.method} ${e.url} - ${n}ms`)}},initLoggerMiddleware:function(){return l.a.koaLogger(l.a.getLogger("http"),{level:"auto",format:d})}},y=r(3),f=r.n(y),m=r(4),g=r.n(m);var w={readImage:function(e){let t=[];return new Promise((r,n)=>{const a=f.a.createReadStream(e);a.on("data",function(e){t.push(e)}),a.on("end",function(){const e=Buffer.concat(t);r(e)}),a.on("error",e=>{n(e)})})},stat:function(e){return new Promise(function(t,r){f.a.stat(e,function(e,n){e?r(e):t(n)})})},mkDirSync:function(e,t){const r=e.split("/");let n=0,a=`${t}/`;return function e(){if(!(n>r.length-1)){a+=`${r[n]}/`;try{n++,f.a.mkdirSync(a)}catch(t){"EEXIST"===t.code&&e()}}}}};const h={"login-invalidate":"登录失败：账号密码错误","mysql-error":"数据库错误","input-invalidate":"输入不合法","input-invalidate-empty":"输入参数为空","input-invalidate-number":"输入参数必须为数字","input-invalidate-status":"非法的文章状态","input-invalidate-oldPwd":"旧密码输入不正确","data-not-find":"数据未找到或不存在","data-is-exist":"数据已存在","no-auth-app":"当前账号无访问此应用权限","no-logined":"未登录","too-frequent":"访问太频繁","must-be-image":"必须是图片","must-be-local-site":"必须是本站点访问","access-token-empty":"","access-token-expired":"access-token已过期","expired-time":"时间已过期","can-not-delete-fishelly":"无法删除此账号","user-exist":"当前用户已存在"},b=function(e){return JSON.parse(JSON.stringify(e))};var v={packData:function(e,t,r){return"success"===t?{code:e,status:t,data:function(e){return e&&e.hasOwnProperty("count")&&e.hasOwnProperty("rows")&&(e={total:e.count,list:e.rows}),(e=b(e))?(e instanceof Array&&(e={list:e}),e):null}(r)}:{code:e,status:t,msg:h[r]||r}},deepClone:b,validator:{isEmpty:e=>void 0===e||null===e||"string"==typeof e&&0===e.length,isNumeric:e=>!isNaN(parseFloat(e))&&isFinite(e),numberic(e){return this.isNumeric(e)},numeric(e){return this.isNumeric(e)},isObject:e=>"object"==typeof e&&!(e instanceof Array),email:e=>/\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/.test(e),chinese:e=>/^[\u4e00-\u9fa5]{0,}$/.test(e),english:e=>/^[a-zA-Z]+$/.test(e),url:e=>/(^#)|(^http(s*):\/\/[^\s]+\.[^\s]+)/.test(e),idcard:e=>/(^\d{15}$)|(^\d{17}(x|X|\d)$)/.test(e),mobile:e=>/^1(3|4|5|7|8)[0-9]\d{8}$/.test(e),document:e=>/\.doc(x?)$|\.xls(x?)$|\.ppt(x?)$|\.wps$|\.pef$|\.txt$/i.test(e),image:e=>/\.png|\.jpg$|\.jpeg$|\.bmp$|\.gif$/i.test(e),video:e=>/\.wmv$|\.avi$|\.mkv$|\.mp4$|\.rmvb$/i.test(e),audio:e=>/\.mp3/i.test(e),archive:e=>/\.rar$|\.zip$|\.7z$|\.gzip$|\.tar$|\.iso$/i.test(e)},redirectData:function(e=302,t,r){return{status:e,url:t,msg:h[r]}}},k=r(2),N=r.n(k);const{validator:q}=v;class ${constructor(){this.cacheMap=new Map}static CreateData(e,t=60){return{data:e,time:N()().unix()+t}}static Check(e){if(q.isEmpty(e))throw new Error("the key can not be empty");return!0}set(e,t,r){if($.Check(e)){const n=$.CreateData(t,r);this.cacheMap.set(e,n)}}get(e){if($.Check(e)){const t=this.cacheMap.get(e);return!t||t.time<N()().unix()?(this.cacheMap.delete(e),null):t.data}}pull(e){const t=this.get(e);return this.cacheMap.delete(e),t}}var T={create:function(e){return this.model.create(e)},findOne:function(e){return e={where:e},this.model.findOne(e)},update:function(e,t){return t={where:t},delete e.id,this.model.update(e,t)},delete:function(e){return e={where:e},this.model.destroy(e)}};const x=p.log4js.getLogger("mysql");var I={username:"root",password:"root",dbname:"koa-usercenter",options:{logging:function(e){x.info(e)},host:"localhost",port:3306,dialect:"mysql",timezone:"+08:00",pool:{max:3,min:0,idle:1e4}}},A=r(0),_=r.n(A);var M=new _.a(I.dbname,I.username,I.password,I.options);var O=M.define("uc_access_token",{id:{type:_.a.BIGINT,primaryKey:!0,autoIncrement:!0},uid:{type:_.a.BIGINT},access_token:{type:_.a.STRING(256),allowNull:!1},refresh_token:{type:_.a.STRING(256),allowNull:!1},expired_time:{type:_.a.BIGINT,allowNull:!1}},{tableName:"uc_access_token",timestamps:!0,freezeTableName:!0});var S=M.define("uc_app",{id:{type:_.a.BIGINT,primaryKey:!0,autoIncrement:!0},name:{type:_.a.STRING(256),allowNull:!1},url:{type:_.a.STRING(256),allowNull:!1},icon:{type:_.a.STRING(256)},ticket:{type:_.a.STRING(256),allowNull:!1}},{tableName:"uc_app",timestamps:!0,freezeTableName:!0});var L=M.define("uc_user",{id:{type:_.a.BIGINT,primaryKey:!0,autoIncrement:!0},account:{type:_.a.STRING(256),allowNull:!1},name:{type:_.a.STRING(256),allowNull:!0},position:{type:_.a.STRING(256),allowNull:!0},signature:{type:_.a.STRING(256),allowNull:!0},label:{type:_.a.STRING(256),allowNull:!0},introduce:{type:_.a.TEXT,allowNull:!0},password:{type:_.a.TEXT,allowNull:!1},headImg:{type:_.a.INTEGER,allowNull:!0}},{tableName:"uc_user",timestamps:!0,freezeTableName:!0});var E=M.define("uc_image",{id:{type:_.a.BIGINT,primaryKey:!0,autoIncrement:!0},name:{type:_.a.STRING,allowNull:!1},ext:{type:_.a.STRING,allowNull:!1},mime:{type:_.a.STRING,allowNull:!1},path:{type:_.a.STRING,allowNull:!1},size:{type:_.a.INTEGER,allowNull:!1},date:{type:_.a.BIGINT,allowNull:!1}},{tableName:"uc_image",timestamps:!0,freezeTableName:!0});var j=M.define("uc_user_app",{appid:{type:_.a.BIGINT,primaryKey:!0},uid:{type:_.a.BIGINT,primaryKey:!0},status:{type:_.a.INTEGER}},{tableName:"uc_user_app",timestamps:!0,freezeTableName:!0});L.belongsToMany(S,{as:"app",through:j,foreignKey:"uid"}),S.belongsToMany(L,{as:"user",through:j,foreignKey:"appid"});const G=_.a.Op,C={model:L,findAndCountAll:function(e,t,r,n){const a={};r&&(a.$or={},a.$or.name={[G.like]:`%${r}%`},a.$or.account={[G.like]:`%${r}%`});const o={order:[["id","asc"]],where:a,limit:e,offset:t};return n&&(o.include={model:S,as:"app"}),this.model.findAndCountAll(o)}};var R=Object.assign(C,T);const D=_.a.Op,P={model:E,findAll:function(e){return e={where:e},this.model.findAll(e)},findAndCountAll:function(e,t,r){const n={};return r&&(n.name={[D.like]:`%${r}%`}),this.model.findAndCountAll({order:[["id","desc"]],where:n,limit:e,offset:t})}};var F=Object.assign(P,T);const z=_.a.Op,K={model:S,findAll:function(e){return e={where:e},this.model.findAll(e)},findAndCountAll:function(e,t,r){const n={};return r&&(n.name={[z.like]:`%${r}%`}),this.model.findAndCountAll({order:[["id","asc"]],where:n,limit:e,offset:t})}};var B=Object.assign(K,T),V=r(7),H=r.n(V);const X=_.a.Op,Y={model:O,findAll:function(e){return e={where:e},this.model.findAll(e)},findAndCountAll:function(e,t,r){const n={};return r&&(n.name={[X.like]:`%${r}%`}),this.model.findAndCountAll({order:[["id","desc"]],where:n,limit:e,offset:t})},getAccessTokenRelatedUID:async function(e){const t=await this.model.findOne({access_token:e});return!t.uid&&(!(t.expired_time<N()().unix())&&t.uid)},refreshAccessToken:async function(e){const t=await this.model.findOne({access_token:e});return!t.uid&&(t.access_token=`access@${H()()}`,t.expired_time=N()().unix()+7200,this.model.update(t,{id:t.id}),t)},generateRefreshToken:function(e){const t={uid:e,refresh_token:`refresh@${H()()}`,access_token:`access@${H()()}`,expired_time:N()().unix()+7200};return this.model.create(t)},refreshTmpToken:async function(e,t){if(!t)throw new Error("parameter error!",1);const r=`tmp@${H()()}`;return e.cache.set(r,t),r},checkAccessToken:async function(e,t){let r=await this.findOne(e);return r.expired_time<N()().unix()?!!t.session.user&&(r=await this.model.refreshAccessToken(r.access_token)).dataValues:r.dataValues}};var U=Object.assign(Y,T);const J=_.a.Op,W={model:j,findAll:function(e){return e={where:e},this.model.findAll(e)},findAndCountAll:function(e,t,r){const n={};return r&&(n.name={[J.like]:`%${r}%`}),this.model.findAndCountAll({order:[["id","desc"]],where:n,limit:e,offset:t})}};var Z=Object.assign(W,T);const Q=v.packData,ee=["/web/"],te=["/ignore","/login"];var re=r(5),ne=r.n(re);const ae=v.packData,oe=["/api/"];let se=null;function ie(e){return async function(t,r){t.type="html",t.body=se.replace("${TITLE}",e.title).replace("${MSG}",e.msg)}}async function ce(e,t){let r=null,n=e.status;if(403===n)switch(e.accepts("html","json")){case"html":r=ie({title:"403 未授权.",msg:"403！抱歉，您没有访问权限~~"}),await r(e);break;case"json":e.status=200,e.body={code:403,status:"error",msg:"CSRF TOKEN或其他TOKEN不匹配"};break;default:e.type="text",e.body="CSRF TOKEN或其他TOKEN不匹配"}else if(404===e.status)switch(e.status=404,e.accepts("html","json")){case"html":r=ie({title:"404 您访问的页面不存在.",msg:"404！抱歉，您查看的页面不存在～～"}),await r(e);break;case"json":e.status=200,e.body={code:404,status:"error",msg:"您访问的页面不存在"};break;default:e.type="text",e.body="Page Not Found"}else if(500===n)switch(e.accepts("html","json")){case"html":r=ie({title:"500 服务器出错.",msg:"500！抱歉，服务器出错，请稍后再访问～～"}),await r(e);break;case"json":e.status=200,e.body={code:500,status:"error",msg:"服务器出错"};break;default:e.type="text",e.body="服务器出错"}t&&t()}se||(se=Object(y.readFileSync)(Object(m.join)(process.cwd(),"public/error","index.html")).toString());var ue={tryCatchMiddleware:async function(e,t){try{await t()}catch(t){e.status=t.status||500,await ce(e),500===e.status&&e.app.emit("error",t,e)}},errorHandleMiddleware:ce},le=r(11),de=r.n(le),pe=r(1),ye=r.n(pe);const fe=v.packData,me=v.validator,ge=v.redirectData;var we=async function(e){const t=e.request.body;try{const r=await B.create(t);return fe(200,"success",r)}catch(t){return e.logger.getLogger("error").error(t),fe(500,"error","mysql-error")}},he=async function(e){const t=e.params;try{const r=await B.findOne({id:t.id});return r?(e.url.includes("/api/")&&delete r.dataValues.ticket,fe(200,"success",r)):fe(404,"error","data-not-find")}catch(t){return e.logger.getLogger("error").error(t),fe(500,"error","mysql-error")}},be=async function(e){const t=e.request.body,r=e.params.id;try{const n=await B.update(t,{id:r});return fe(200,"success",n)}catch(t){return e.logger.getLogger("error").error(t),fe(500,"error","mysql-error")}},ve=async function(e){e.request.body;const t=e.params;try{const r=await B.delete({id:t.id});return fe(200,"success",r)}catch(t){return e.logger.getLogger("error").error(t),fe(500,"error","mysql-error")}},ke=async function(e){e.request.body,e.params;try{const t=await B.findAll();return e.url.includes("/api/")&&t.forEach(e=>{delete e.dataValues.ticket}),fe(200,"success",t)}catch(t){return e.logger.getLogger("error").error(t),fe(500,"error","mysql-error")}},Ne=async function(e){const t=e.request.query;let r=t.limit,n=t.offset;if(me.isEmpty(r)||me.isEmpty(n))return fe(412,"error","input-invalidate-empty");if(!me.isNumeric(r)||!me.isNumeric(n))return fe(412,"error","input-invalidate-number");r=Number(r),n=Number(n);try{const a=await B.findAndCountAll(r,n,t.keyword);return e.url.includes("/api/")&&a.rows.forEach(e=>{delete e.dataValues.ticket}),fe(200,"success",a)}catch(t){return e.logger.getLogger("error").error(t),fe(500,"error","mysql-error")}},qe=async function(e){const t=e.params;try{const r=await B.findOne({id:t.id.replace("fs","")});return r?(delete r.dataValues.ticket,delete r.dataValues.id,fe(200,"success",r)):fe(404,"error","data-not-find")}catch(t){return e.logger.getLogger("error").error(t),fe(500,"error","mysql-error")}},$e=async function(e){const t=e.request.query.redirect_url;if(!t)return ge(412,"/error","input-invalidate-empty");const r=await U.refreshTmpToken(e,e.session.user.id);return ge(302,`${t}?access_token=${r}`)};const Te=v.packData,xe=v.validator;var Ie=async function(e,t){const r=e.request.body;r.path=t.path,r.mime=t.type,r.name=t.name,r.size=t.size,r.name=t.name;try{r.date=N()().unix();const t=await F.create(r);return Te(200,"success",t)}catch(t){return console.log(t),e.logger.getLogger("error").error(t),Te(500,"error","mysql-error")}},Ae=async function(e){e.request.body;const t=e.params;try{const r=await F.findOne({id:t.id});return r?Te(200,"success",r):Te(404,"error","data-not-find")}catch(t){return e.logger.getLogger("error").error(t),Te(500,"error","mysql-error")}},_e=async function(e){const t=e.request.body,r=e.params.id;try{const n=await F.update(t,{id:r});return Te(200,"success",n)}catch(t){return e.logger.getLogger("error").error(t),Te(500,"error","mysql-error")}},Me=async function(e){e.request.body;const t=e.params;try{const r=await F.delete({id:t.id});return Te(200,"success",r)}catch(t){return e.logger.getLogger("error").error(t),Te(500,"error","mysql-error")}},Oe=async function(e){e.request.body,e.params;try{const t=await F.findAll(),r=Te(200,"success",t);return r.data.list=r.data.list.map(t=>(t.url=`${e.origin}/web/image/view/${t.id}`,delete t.path,t)),r}catch(t){return e.logger.getLogger("error").error(t),Te(500,"error","mysql-error")}},Se=async function(e){const t=e.request.body;let r=t.limit,n=t.offset;if(xe.isEmpty(r)||xe.isEmpty(n))return Te(412,"error","input-invalidate-empty");if(!xe.isNumeric(r)||!xe.isNumeric(n))return Te(412,"error","input-invalidate-number");r=Number(r),n=Number(n);try{const a=await F.findAndCountAll(r,n,t.keyword),o=Te(200,"success",a);return o.data.list=o.data.list.map(t=>(t.url=`${e.origin}/web/image/view/${t.id}`,delete t.path,t)),o}catch(t){return e.logger.getLogger("error").error(t),Te(500,"error","mysql-error")}};const Le=v.packData,Ee=v.validator,je=v.deepClone,Ge=v.redirectData;var Ce=async function(e){const t=e.request.body;if(!e.session.user)return Ge(401,"/error","no-logined");try{if(t.appid){const r=await B.findOne({id:t.appid.replace("fs","")});if(!r.dataValues.id)return Ge(404,"/error","data-not-find");const n=await U.refreshTmpToken(e,e.session.user.id);return Ge(302,`${r.url}?access_token=${n}`)}return Ge(412,"/error","input-invalidate-empty")}catch(t){return console.log(t),e.logger.getLogger("error").error(t),Ge(500,"/error","mysql-error")}},Re=async function(e){const t=e.request.body,r=t.account,n=(t.appid||"").replace("fs","");let a=t.password;if(Ee.isEmpty(a)||Ee.isEmpty(r))return Le(412,"error","input-invalidate-empty");a=ne()(a);try{const t=await R.findOne({account:r});if(t&&t.password===a){let r=!1;if(n){let e=await t.getApp();r=!!(e=je(e)).map(e=>({id:e.id,status:e.uc_user_app.status})).filter(e=>Number(e.id)===Number(n)&&e.status).length}return n&&!r?Le(403,"error","no-auth-app"):(delete t.dataValues.password,e.session.user=t,Le(200,"success",{user:t}))}return Le(401.1,"error","login-invalidate")}catch(t){return console.log(t),e.logger.getLogger("error").error(t),Le(500,"error","mysql-error")}},De=async function(e){try{const t=e.request.body,r=await R.findOne({account:t.account});if(r&&r.dataValues.id)return Le(403,"error","user-exist");t.password||(t.password=ne()("Koauc123#"));const n=await R.create(t);return Le(200,"success",n)}catch(t){return e.logger.getLogger("error").error(t),Le(500,"error","mysql-error")}},Pe=async function(e){const t=e.request.body,r=t.id;if(!r)return Le(412,"error","input-invalidate-empty");try{delete t.password,delete t.account,delete t.id;const n=await R.update(t,{id:r});return Le(200,"success",n)}catch(t){return e.logger.getLogger("error").error(t),Le(500,"error","mysql-error")}},Fe=async function(e){return e.session.user=null,Le(200,"success",{})},ze=async function(e){const t=e.request.body.access_token;if(!t)return Le(412,"error","access-token-empty");const r=e.cache.pull(t);return r?Le(200,"success",await R.findOne({id:r})):Le(412,"error","access-token-expired")},Ke=async function(e){e.request.body;const t=e.params;try{if(1===(await R.findOne({id:t.id})).dataValues.id)return Le(403,"error","can-not-delete-fishelly");const r=await R.delete({id:t.id});return Le(200,"success",r)}catch(t){return e.logger.getLogger("error").error(t),Le(500,"error","mysql-error")}},Be=async function(e){const t=e.request.query;let r=t.limit,n=t.offset;if(Ee.isEmpty(r)||Ee.isEmpty(n))return Le(412,"error","input-invalidate-empty");if(!Ee.isNumeric(r)||!Ee.isNumeric(n))return Le(412,"error","input-invalidate-number");r=Number(r),n=Number(n);try{const a=await R.findAndCountAll(r,n,t.keyword,t.includes);return Le(200,"success",a)}catch(t){return e.logger.getLogger("error").error(t),Le(500,"error","mysql-error")}};const Ve=v.packData;var He=async function(e){const t=e.session.user;if(!t)return Ve(401,"error","no-logined");try{const r=await Z.findAll({uid:t.id}),n=await B.findAll();return Ve(200,"success",{userApps:r,allApps:n})}catch(t){return e.logger.getLogger("error").error(t),Ve(500,"error","mysql-error")}},Xe=async function(e){try{const t=e.request.body;if(await Z.findOne({appid:t.appid,uid:t.uid}))return Ve(412,"error","data-is-exist");const r=await R.findOne({id:t.uid}),n=await B.findOne({id:t.appid});return r&&n?(await r.addApp(n,{through:{status:1}}),Ve(200,"success",null)):Ve(403,"error","data-not-find")}catch(t){return e.logger.getLogger("error").error(t),Ve(500,"error","mysql-error")}},Ye=async function(e){const t=e.params;try{const r=await Z.delete({appid:t.appid,uid:t.uid});return Ve(200,"success",r)}catch(t){return e.logger.getLogger("error").error(t),Ve(500,"error","mysql-error")}},Ue=async function(e){const t=e.session.user,r=e.params,n=e.request.body;if(!t)return Ve(401,"error","no-logined");try{const a=r.appId,o=t.id,s=n.status||0,i=await Z.update({status:s},{uid:o,appid:a});return Ve(200,"success",i)}catch(t){return console.log(t),e.logger.getLogger("error").error(t),Ve(500,"error","mysql-error")}};const Je=ye()();Je.post("/logined",async function(e,t){const r=await Ce(e);e.status=r.status,e.status>400||e.redirect(r.url)}),Je.get("/logout",async function(e,t){e.body=await Fe(e)}),Je.put("/",async function(e,t){e.body=await Pe(e)}),Je.post("/",async function(e,t){e.body=await De(e)}),Je.get("/",async function(e,t){e.body=await Be(e)}),Je.delete("/:id",async function(e){e.body=await Ke(e)});var We=Je;const Ze=ye()();Ze.post("/",async function(e,t){e.body=await we(e)}),Ze.get("/",async function(e,t){e.body=await Ne(e)}),Ze.get("/all",async function(e,t){e.body=await ke(e)}),Ze.get("/goto",async function(e,t){const r=await $e(e);e.status=r.status,e.status>400||e.redirect(r.url)}),Ze.get("/:id",async function(e,t){e.body=await he(e)}),Ze.put("/:id",async function(e,t){e.body=await be(e)}),Ze.delete("/:id",async function(e,t){e.body=await ve(e)});var Qe=Ze;const et=ye()();et.get("/view/:id",async function(e,t){const r=await Ae(e);if(!r.data)return void(e.status=404);const n=r.data,a=g.a.join(e._dir_path,n.path);(await w.stat(a)).isFile()&&(e.status=r.code,e.type=n.mime,e.body=await w.readImage(a))}),et.get("/",async function(e,t){e.body=await Se(e)}),et.get("/all",async function(e,t){e.body=await Oe(e)}),et.post("/",async function(e,t){const r=e.request.files.file,n=f.a.createReadStream(r.path),a=`uploads/images/${N()().format("YYYY-MM-DD")}`,o=Number.parseInt(1e6*Math.random().toString()),s=r.name.split("."),i=s[s.length-1],c=`${a}/${N()().unix()}${o}.${i}`,u=g.a.join(e._dir_path,c);w.mkDirSync(a,e._dir_path)();const l=f.a.createWriteStream(u);n.pipe(l),r.path=c,e.body=await Ie(e,r)}),et.put("/:id",async function(e,t){e.body=await _e(e)}),et.delete("/:id",async function(e,t){e.body=await Me(e)});var tt=et;const rt=ye()();rt.post("/",async function(e,t){e.body=await Xe(e)}),rt.put("/:appId",async function(e,t){e.body=await Ue(e)}),rt.delete("/:uid/:appid",async function(e,t){e.body=await Ye(e)}),rt.get("/user/apps",async function(e,t){e.body=await He(e)});var nt=rt;const at=ye()();at.post("/user/checklogin",async function(e,t){e.body=await Re(e)}),at.get("/apps/info/:id",async function(e,t){e.body=await qe(e)});var ot=at;const st=ye()();st.post("/login",async function(e,t){e.body=await ze(e)});var it=st;const ct=ye()();ct.use("/web/user",We.routes(),We.allowedMethods()),ct.use("/web/image",tt.routes(),tt.allowedMethods()),ct.use("/web/apps",Qe.routes(),Qe.allowedMethods()),ct.use("/web/auth",nt.routes(),nt.allowedMethods()),ct.use("/web/ignore",ot.routes(),ot.allowedMethods()),ct.use("/web/oauth",it.routes(),it.allowedMethods());var ut=ct;const lt=ye()();lt.get("/view/:id",async function(e,t){const r=await Ae(e);if(!r.data)return void(e.status=404);const n=r.data,a=g.a.join(e._dir_path,n.path);(await w.stat(a)).isFile()&&(e.status=r.code,e.type=n.mime,e.body=await w.readImage(a))});var dt=lt;var pt=ye()();const yt=ye()();yt.get("/",async function(e,t){e.body=await Ne(e)}),yt.get("/all",async function(e,t){e.body=await ke(e)});var ft=yt;const mt=ye()();mt.use("/api/image",dt.routes(),dt.allowedMethods()),mt.use("/api/user",pt.routes(),pt.allowedMethods()),mt.use("/api/app",ft.routes(),ft.allowedMethods());var gt=mt;const wt=ye()();let ht=null;wt.get("/",async function(e,t){ht||(ht=Object(y.readFileSync)(Object(m.join)(e._dir_path,"public/admin","index.html")).toString()),e.type="html",e.body=ht.replace("${CSRF}",e.csrf)});var bt=wt;const vt=ye()();vt.use("/",bt.routes(),bt.allowedMethods());var kt=vt,Nt=r(10),qt=r.n(Nt);const{log4js:$t,routeLoggerMiddleware:Tt,initLoggerMiddleware:xt}=p,{errorHandleMiddleware:It,tryCatchMiddleware:At}=ue,_t=new o.a,Mt=($t.getLogger("app"),$t.getLogger("error"));_t.use(At),_t.use(xt()),_t.use(function(){const e=new $;return async function(t,r){t.cache=e,await r()}}()),_t.use(function(e){return async(t,r)=>{t._dir_path=e,t._server_config=n,await r()}}(process.cwd())),_t.use(async function(e,t){let r=e.url;const n=await async function(e){const t=e.header.access_token,r=e.session.user;let n=null;return!t&&r?n=r.id:t&&(n=await U.getAccessTokenRelatedUID(t)),!!n}(e);if(function(e){return!te.filter(t=>!e.includes(t)).length&&ee.filter(t=>e.includes(t)).length>0}(r)&&!n)return e.body=Q(401,"error","no-logined"),!1;await t()}),_t.use(async function(e,t){if(function(e){return!e.includes("ignore")&&oe.filter(t=>e.includes(t)).length>0}(e.url)&&!(await async function(e){let t={};const r=(t="GET"===e.method?e.request.query:e.request.body).token,n=t.time,a=N()().unix(),o=(t.appid||"").trim();if(!r||!n||!o)return{result:!1,data:ae(412,"error","input-invalidate-empty")};if(a-n>3e3)return{result:!1,data:ae(403,"error","expired-time")};const s=await B.findOne({id:o.replace("fs","")});if(!s)return{result:!1,data:ae(404,"error","data-not-find")};const i=s.ticket;return{result:ne()(`${i}${o}${n}`)===r}}(e)).result)return!1;await t()}),_t.use(async function(e,t){e.request.url.includes("/public/")?(e.set("Service-Worker-Allowed","/"),await de()(e,e.path,{root:`${e._dir_path}`,maxage:31536e9})):await t()}),_t.keys=["user logined secret"],_t.use(c()({key:"koa:sess",maxAge:72e5,overwrite:!0,httpOnly:!0,signed:!0},_t)),_t.use(s({multipart:!0,formLimit:"5mb",jsonLimit:"5mb",textLimit:"5mb"})),_t.use(new qt.a),_t.use(ut.routes(),ut.allowedMethods()),_t.use(gt.routes(),gt.allowedMethods()),_t.use(kt.routes(),kt.allowedMethods()),_t.use(It),_t.use(Tt()),_t.on("error",e=>{Mt.error("server error",e)});var Ot=_t,St=r(8),Lt=r.n(St),Et=r(9),jt=r.n(Et);const{log4js:Gt}=p,Ct=Gt.getLogger("startup"),Rt=Ft(n.port||"80");let Dt=null,Pt=null;function Ft(e){const t=parseInt(e,10);return isNaN(t)?e:t>=0&&t}function zt(e){if("listen"!==e.syscall)throw Ct.error("error: "+e),e;const t="string"==typeof Rt?"Pipe "+Rt:"Port "+Rt;switch(e.code){case"EACCES":Ct.error(t+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":Ct.error(t+" is already in use"),process.exit(1);break;default:throw Ct.error("error: "+e),e}}function Kt(){let e=Dt.address();const t="string"==typeof e?"pipe "+e:"port "+e.port;Ct.info("HTTP Listening on "+t),n.useHttps&&(e=Pt.address(),Ct.info("HTTPS Listening on "+n.ssl.port))}n.useHttps?((Pt=jt.a.createServer({key:f.a.readFileSync(`${n.ssl.path}${n.ssl.key}`),cert:f.a.readFileSync(`${n.ssl.path}${n.ssl.pem}`),passphrase:n.ssl.passphrase},function(e,t){if(!e.headers.host.includes("www.")){const r=e.url.substr(1);return t.writeHead(301,{Location:`${n.host}${r}`}),void t.end()}return Ot.callback()(e,t)})).listen(Ft(n.ssl.port||"443")),Pt.on("error",zt),Pt.on("listening",Kt),Dt=Lt.a.createServer(function(e,t){const r=e.url.substr(1);t.writeHead(301,{Location:`${n.host}${r}`}),t.end()})):Dt=Lt.a.createServer(Ot.callback()),Dt.listen(Rt),Dt.on("error",zt),Dt.on("listening",Kt)},function(e,t){for(var r=[],n=0;n<256;++n)r[n]=(n+256).toString(16).substr(1);e.exports=function(e,t){var n=t||0,a=r;return[a[e[n++]],a[e[n++]],a[e[n++]],a[e[n++]],"-",a[e[n++]],a[e[n++]],"-",a[e[n++]],a[e[n++]],"-",a[e[n++]],a[e[n++]],"-",a[e[n++]],a[e[n++]],a[e[n++]],a[e[n++]],a[e[n++]],a[e[n++]]].join("")}},function(e,t){e.exports=require("crypto")},function(e,t,r){var n=r(17);e.exports=function(){return n.randomBytes(16)}},function(e,t,r){e.exports=r(15)}]);